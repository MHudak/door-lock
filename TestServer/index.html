<!DOCTYPE html>
    <head>
        <title>Apt5635 Unlockerino</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style type="text/css">
            .fouc {display: none;}
            .smess {color:green;}
            .fmess {color:red;}
        </style>
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css" />
        <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>       
    </head>
    <body class="fouc">   
        <div data-role="page">
            <div data-role="header">
                <h1>Welcome to 5635</h1>
                </div>
            <div data-role="content">
                <h2>Welcome to 5635</h2>
            </div>
        </div><!-- page -->

        <div data-role="page" id="enter-seed">
            <div data-role="header">
                <h1>Welcome to 5635</h1>
            </div>
            <div data-role="content">
                <h1>You're new here.</h1>
                <p>You were given a seed (fancy word for number) with your username and password.</p><h2>Enter your seed below:</h2>
                <form action="#login" onsubmi>
                    <!--TODO add onchange validation to allow only numbers to be input into textbox"-->
                    <!--TODO beautify or rethink the validation error message-->
                    <!--TODO maybe move oninvalid code to script tag-->
                    <input id="user-seed" type="text" name="user-seed" pattern="\d+"
                            oninvalid="setCustomValidity('The seed should contain only decimal digits.')">
                    <input type="submit" value="Go!">
                </form>
            </div>
        </div><!-- page -->

        <div data-role="page" id="login">
            <div data-role="header">
                <h1>Welcome to 5635</h1>
            </div>
            <div data-role="content">
                <h1>Login</h1>
                <!-- TODO prevent multiple submits until success/failure page-->
                <form action="#lock-unlock" method="POST">
                    Username: <input id="user-id" type="text" name="user-id">
                    Password: <input id="user-password" type="password" name="user-password">
                    <input type="submit" value="Go!">
                    <p class="fmess">Incorrect username or password.</p>
                </form>
            </div>
        </div><!-- page -->
        
        <div data-role="page" id="door-lock-unlock">
            <div data-role="header">
                <h1>Welcome to 5635</h1>
            </div>
            <div data-role="content">
                <form>
                    <fieldset>
                      <div data-role="fieldcontain">
                        <label for="select-based-flipswitch">Select Command: </label>
                        <select id="select-based-flipswitch" data-role="flipswitch">
                          <option value="open">Open</option>
                          <option value="close">Close&nbsp;</option>
                        </select>
                      </div>
                    </fieldset>
                    <p class="smess">Success</p>
                    <p class="fmess">An error occurred (probably a timeout). Please try again.</p>
                    <input type="submit" value="Go!">
                </form>
            </div>
        </div>

        <div data-role="page" id="success">
            <div data-role="header">
                <h1>Welcome to 5635</h1>
            </div>
            <div data-role="content">
                <h2>success</h2>
            </div>
        </div><!-- page -->

    <footer>
        <script>   
            var PASSWORD_LENGTH = 8;
            var username = "";
            var password = "";
            var seed = null;
            var resaltPassword = true;
                    
            //random number generator
            var currentRandomNumberSeed = 0;
            function getRandomInt(){
                currentRandomNumberSeed = currentRandomNumberSeed & 0xFFF;
                currentRandomNumberSeed = (214013 * currentRandomNumberSeed + 2531011)%16777216;
                return currentRandomNumberSeed;
            }
            function calculatePassword(password){
                currentRandomNumberSeed = parseInt(localStorage.getItem("seed"));
                var saltedPW = "";
                var i;
                for(i = 0; i < password.length && i < (PASSWORD_LENGTH*3); i++){
                    saltedPW += format(((password.charCodeAt(i) + getRandomInt()) % 256), 3);
                }
                while(saltedPW.length < (PASSWORD_LENGTH*3)){
                    saltedPW += format(((getRandomInt()) % 256), 3);
                }
                return saltedPW;
            }       

            //url formatter     
            function format(value, length){
                var returnVal = new Array();
                while(length-- > 0){
                    if(value > 0){
                        returnVal[length] = value%10;
                        value = Math.floor(value/10);
                    }else{
                        returnVal[length] = 0;
                    }
                }
                return returnVal.join("");
            }

    $( document ).ready(function() {
        $(".smess").hide();
        $(".fmess").hide();
        checkSeed();
    });

    //check for seed value stored on client's computer
    function checkSeed() {
        seed=localStorage.getItem("seed");
        if (seed != null) {
            currentRandomNumberSeed = parseInt(seed);
            $(":mobile-pagecontainer").pagecontainer( "change", "#login", {transition: "flip"});
        } else {
            // if no seed exists, prompt user to enter their given seed value
            $(":mobile-pagecontainer").pagecontainer( "change", "#enter-seed", {transition: "flip"});
        }
        $(".fouc").removeClass("fouc");
    }   

    $("#enter-seed").submit(function(e)
    {
        seed = e.target["user-seed"].value;

        if(!!seed){
            localStorage.setItem("seed", seed);
            currentRandomNumberSeed = parseInt(localStorage.getItem("seed"));
            $(":mobile-pagecontainer").pagecontainer( "change", "#login", {transition: "flip"}); 
        }
        return false;
    });
    $("#login").submit(function(e){
        $(".fmess").hide();
        username = e.target["user-id"].value;
        password = e.target["user-password"].value;
        if(resaltPassword){
            resaltPassword = false;
            var saltedPW = calculatePassword(password);
        }
        var formURL = "/?uname=" + username + "&pw=" + saltedPW;
        $.ajax(
        {
            url : formURL,
            type: "GET",

            // Successful seed submission, take user to login page
            success:function(data, textStatus, jqXHR) 
            {
                resaltPassword = true;
                $(":mobile-pagecontainer").pagecontainer( "change", "#door-lock-unlock", {transition: "flip"});
                localStorage.setItem("seed", currentRandomNumberSeed);
            },
            //TODO implement better failure notification transition
            //failed seed submission, take to failure notification page
            error: function(jqXHR, textStatus, errorThrown) 
            {
                resaltPassword = true;
                $(".error-message").show();
            }
        });
    });

    $("#door-lock-unlock").submit(function(e){
        $(".smess").hide();
        $(".fmess").hide();
        if(resaltPassword){
            resaltPassword = false;
            var saltedPW = calculatePassword(password);
        }
        var formURL = "/?" + "cmd=" + e.target["select-based-flipswitch"].value  + "&uname=" + username + "&pw=" + saltedPW;

        $.ajax(
        {
            url : formURL,
            type: "GET",
            
            success:function(data, textStatus, jqXHR) 
            {
                resaltPassword = true;
                $(".smess").show();
                localStorage.setItem("seed", currentRandomNumberSeed);
            },
            error: function(jqXHR, textStatus, errorThrown) 
            {
                resaltPassword = true;
                $(".fmess").show();
            }
        });
        return false;
    });
        </script>
    </footer>
    </body>
</html>
